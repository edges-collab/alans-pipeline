# Alan's C Pipeline

This repository contains Alan's full C-pipeline for producing
averaged, calibrated spectra.

The repository is maintained primarily by @steven-murray
and @nmahesh1412, not by Alan himself, so it is not necessarily
"up-to-date" with whatever Alan is running *right now*.
It is rather a place where we can easily tag specific versions
that correspond to particular outputs/memos/papers in order
to have something very concrete to come back to in later
comparisons.

The initial motivation for this release was to set in stone
exactly what was done for the H2 case in the Nature Paper
(corresponding to Figure 1 of Bowman 2018). You will find
scripts for this in the `scripts/` directory.

## Repository Layout

The `src/` directory contains all the source C-code.
There is;

* `acqplot7amoon.c`: for reading and averaging spectra.
* `edges2k.c`: for computing lab-calibration solutions, and applying them to spectra
* `longav.c`: for combining multiple days of data and averaging them.

The `data/` directory contains some input data products required for
particular scripts. Eg., a beam model, an antenna S11 model, and a
lab calibration S11 measurement. Note that this data input is specific
to a particular calibration/antenna/receiver. We provide some example
data that correspond to particular cases of interest (eg. the H2 case from
Bowman 2018).

The `results/` directory contains outputs from parts of the pipeline that
are particularly important for following parts of the pipeline, specific
to particular cases. These should be able to be generated by the scripts
themselves, but we keep copies of the results here that were given *by
Alan himself* to make sure that future incantations of the code can
line up with them exactly (essentially a little integration test).

The `scripts/` directory contains C-shell scripts for running the full
pipeline. Typically, two scripts will be required for each full run:
a lab-cal script and then a field-data script. The initial release
of the repo comes with scripts that are able to exactly reproduce
the H2 case. These scripts need to be run on the ASU `enterprise` machine,
because they access large data stored there (which we are *not* going to keep
in the repo).

## Installation


Should be as easy as typing `make`. All the executables will be placed
in `bin/`. Make sure to create a 'bin/' directory before running 'make'.

## Re-creating the H2 case.

To re-create the H2 case, first run `make` in the top-level directory to make the 
binaries. Then:

    $ cd scripts
    $ ./run-H2-cal

Ensure that the `use_fittp_fix` option is set to `0` to exactly reproduce the B18 results.
The resulting `specal.txt` file from that run will be saved in `scripts/H2Case/specal.txt`.
To check that this file is exactly the same as that used in B18, run the `compare_h2cal_outputs.ipynb`
notebook, which prints the maximum difference between that file and the `results/specal_final_case2.txt`
file, which was directly provided by Alan.

Following this, run

    $ ./run-H2-field-data

which will do the data averaging and calibration.
